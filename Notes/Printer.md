# Epson Receipt Printer

Most client services generate a "receipt" which may be a ticket to pick up food or other goods,
a reminder of future service visits, or some other tangible evidence of a service interaction.
These receipts are printed on an Epson POS thermal printer, similar to a grocery store receipt.

## Current Architecture

Receipts are generated by the application code, and the contents to be printed are stored in a
database table, which is accessed using a REST interface. A print server program polls the
database table for receipts to be printed and sends the appropriate commands to the Epson printer.
Multiple instances of the application program can run simultaneously and insert receipts into
the database table. The print server gathers all receipts and prints them on the same Epson
printer. For debugging purposes without a printer, the print server can print a facsimile of
each receipt on the screen instead.

```
print_server.py [-h] [-f FILE] [-i] [-p PRINTER] [-q QUEUE] [-t] [-v VERBOSITY]

options:
  -h, --help            show this help message and exit
  -f FILE, --file FILE  file to receive printer commands
  -i, --interactive     display receipts on screen instead of printing
  -p PRINTER, --printer PRINTER
                        IP address of Epson printer
  -q QUEUE, --queue QUEUE
                        print queue to poll (dev or prod)
  -t, --test            print test receipt and exit
  -v VERBOSITY, --verbosity VERBOSITY
                        level of debug tracing (0-2)
```

To print receipts on screen while debugging, run `print_server.py -i -q dev`.  
To clear receipts accumulated in the print queue, run `print_server.py -f /dev/null -q dev`.

## Private Network Restrictions

In the past, the application communicated directly with the Epson printer on the local network using Epson's ePOS client library. However, Google has
announced that future releases of Chrome will [restrict access](https://developer.chrome.com/blog/private-network-access-update/) 
by Web applications to devices on the local private network of the browser. These restrictions are intended to thwart attacks on routers
and other local network infrastructure.

Before allowing access to a local network device, the Chrome browser will generate a "preflight request" to which the device must respond with a
special HTTP header `Access-Control-Allow-Private-Network`. While we are unable to modify the Epson printer to generate this header, we did
attempt to interpose our custom print server to generate the proper headers and proxy requests to the Epson printer. However, there is an added
complication imposed by previous Chrome policies that require the Web application accessing the local network to run from a "trusted" source
(meaning HTTPS) and to use HTTPS for any connections to local network devices. This would require the print server to be an HTTPS server with
a domain name resolvable by public DNS and a public-key certificate issued by recognized certificate authority (CA). Note: There is an 
[experimental Chrome flag](chrome://flags/#unsafely-treat-insecure-origin-as-secure) to temporarily override the HTTPS restriction.

Given the logistical challenges involved in configuring the print server to be accessed directly by the Web application, we instead chose
the architecture described above. The Web application inserts requests in a "print queue" maintained by the application database, which is
periodically queried by the print server running on the local network.

## Print Server Requirements

The print server is implemented as a Python program, which can run anywhere on the same network as the Epson printer. For convenience, we run
the print server on the same PC that runs the browser primarily used to access the Web application. However, the single print server can
support print requests from any number of additional browsers running the application simultaneously.

The only dependency of the print server not found in a standard Python installation is the `escpos` module. This module can be installed by the 
command `pip install escpos`, which will also install several dependencies required by `escpos`.

### Mac OS Special Requirements

1. The version of Python preinstalled on Mac OS 13 does not properly support `tkinter`, which is needed for on-screen display
of receipts when running the print server in interactive mode. Upgrade to the latest stable Python release (3.11 as of Aug 2023)
and verify that the command `python3 -m tkinter` correctly displays an on-screen window with two buttons. This step is not required
for regular production use of the print server with an Epson printer.

2. In order to a make an HTTPS client connection to access the REST interface for the print queue, Python requires access to the
set of certificate authorities configured for the operating system. This requires a one-time command as follows.
```
$ cd /Applications/Python\ 3.11
$ ./Install\ Certificates.command
```

## Epson Printer Details

- Printer model: Epson TM-T88V
- [Firmware update](https://files.support.epson.com/pdf/pos/bulk/ub-r04-firmware_update_instructions.pdf) - current v1.05
- [Epson ePOS SDK for Javascript](https://download.epson-biz.com/modules/pos/index.php?page=single_soft&cid=7293&scat=57&pcat=52)
